{% extends "base.html" %}
{% block content %}
<h2 class="text-xl font-semibold mb-4">ðŸ“‹ Food Log</h2>
{% if entries %}
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
    {% for entry in entries %}
    {% set images = get_images(entry['id']) %}
    {% set image_urls = [] %}
    {% for image in images %}
        {% set _ = image_urls.append(url_for('static', filename='uploads/' + image['filename'])) %}
    {% endfor %}
    <div class="bg-white shadow-lg rounded-xl p-6 hover:shadow-xl transition-shadow duration-300 border border-gray-100"
         data-entry-id="{{ entry['id'] }}"
         data-title="{{ entry['title'] }}"
         data-description="{{ entry['description'] }}"
         data-food-type="{{ entry['food_type'] }}"
         data-timestamp="{{ entry['timestamp'] }}"
         data-images="{{ image_urls|tojson|e }}">
        <div class="flex justify-between items-start mb-3">
            <h3 class="text-lg font-bold text-pink-700 line-clamp-2">{{ entry['title'] }}</h3>
            <span class="text-xs bg-pink-100 text-pink-800 px-2 py-1 rounded-full whitespace-nowrap ml-2">{{ entry['food_type'] }}</span>
        </div>
        <p class="text-sm text-gray-500 mb-3">ðŸ“… {{ entry['timestamp'] }}</p>
        <p class="text-gray-700 mb-4 line-clamp-3">{{ entry['description']|safe }}</p>
        {% if images %}
        <div class="mb-4">
            <div class="flex gap-2 overflow-x-auto pb-2">
                {% for image in images[:3] %}
                    <img src="{{ url_for('static', filename='uploads/' + image['filename']) }}" 
                         class="w-20 h-20 object-cover rounded-lg flex-shrink-0 cursor-pointer hover:opacity-80 transition-opacity" 
                         alt="Food image">
                {% endfor %}
                {% if images|length > 3 %}
                    <div class="w-20 h-20 bg-gray-100 rounded-lg flex items-center justify-center text-gray-500 text-sm font-medium">
                        +{{ images|length - 3 }}
                    </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
        <div class="flex justify-between items-center">
            <button onclick="openModal('{{ entry.id }}')" 
                    class="bg-pink-500 text-white px-4 py-2 rounded-lg hover:bg-pink-600 transition-colors duration-200 text-sm font-medium">
                View Details
            </button>
            <div class="flex flex-row items-center gap-2 text-sm">
                <a href="{{ url_for('edit_entry', entry_id=entry['id']) }}" 
                    class="text-blue-600 hover:text-blue-800 font-medium transition-colors">Edit</a>
                <form action="{{ url_for('delete_entry', entry_id=entry['id']) }}" method="post" 
                    onsubmit="return confirm('Are you sure you want to delete this entry?');">
         <button type="submit" class="text-red-600 hover:text-red-800 font-medium transition-colors">Delete</button>
    </form>
</div>

        </div>
    </div>
    {% endfor %}
</div>

<!-- Modal Overlay -->
<div id="modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
    <div class="bg-white rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
        <!-- Modal Header -->
        <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center rounded-t-2xl">
            <h3 id="modal-title" class="text-2xl font-bold text-pink-700"></h3>
            <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700 text-2xl font-bold">Ã—</button>
        </div>

        <!-- Modal Content -->
        <div class="p-6">
            <!-- Image Carousel -->
            <div id="carousel-container" class="relative w-full h-64 mb-6 rounded-lg overflow-hidden bg-gray-100 hidden">
                <div id="carousel-images" class="w-full h-full relative"></div>
                <button id="prev-btn" onclick="changeSlide(-1)" class="absolute top-1/2 left-2 transform -translate-y-1/2 bg-white bg-opacity-75 hover:bg-opacity-100 text-gray-700 rounded-full p-2 hidden">
                    â€¹
                </button>
                <button id="next-btn" onclick="changeSlide(1)" class="absolute top-1/2 right-2 transform -translate-y-1/2 bg-white bg-opacity-75 hover:bg-opacity-100 text-gray-700 rounded-full p-2 hidden">
                    â€º
                </button>
                <div id="carousel-indicators" class="absolute bottom-2 left-1/2 transform -translate-x-1/2 flex gap-2"></div>
            </div>

            <!-- Entry Info -->
            <div class="mb-6">
                <div class="flex items-center gap-4 mb-4">
                    <span id="modal-type" class="bg-pink-100 text-pink-800 px-3 py-1 rounded-full text-sm font-medium"></span>
                    <span id="modal-timestamp" class="text-gray-600 text-sm"></span>
                </div>
                <div id="modal-description" class="text-gray-700 text-lg leading-relaxed prose max-w-none"></div>
            </div>

            <!-- Action Buttons -->
            <div class="mt-8 flex gap-4 justify-end">
                <a id="modal-edit-btn" href="#" 
                   class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition-colors duration-200 font-medium">
                    Edit Entry
                </a>
                <button onclick="closeModal()" 
                        class="bg-gray-300 text-gray-700 px-6 py-2 rounded-lg hover:bg-gray-400 transition-colors duration-200 font-medium">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let currentSlide = 0;
let totalSlides = 0;
let modalData = {};

function openModal(entryId) {
    const entryCard = document.querySelector(`[data-entry-id="${entryId}"]`);
    if (!entryCard) return;

    const title = entryCard.dataset.title;
    const description = entryCard.dataset.description;
    const foodType = entryCard.dataset.foodType;
    const timestamp = entryCard.dataset.timestamp;
    const imagesJson = entryCard.dataset.images;

    let images = [];
    try {
        images = JSON.parse(imagesJson || '[]');
    } catch (e) {
        images = [];
    }

    modalData = { id: entryId, title, description, food_type: foodType, timestamp, images };

    document.getElementById('modal-title').textContent = title;
    document.getElementById('modal-type').textContent = foodType;
    document.getElementById('modal-timestamp').textContent = timestamp;
    document.getElementById('modal-description').innerHTML = description;
    document.getElementById('modal-edit-btn').href = `/edit/${entryId}`;

    setupCarousel(images);
    document.getElementById('modal').classList.remove('hidden');
    document.getElementById('modal').classList.add('flex');
    document.body.style.overflow = 'hidden';
}

function closeModal() {
    document.getElementById('modal').classList.add('hidden');
    document.getElementById('modal').classList.remove('flex');
    document.body.style.overflow = 'auto';
}

function setupCarousel(images) {
    const carouselContainer = document.getElementById('carousel-container');
    const carouselImages = document.getElementById('carousel-images');
    const indicators = document.getElementById('carousel-indicators');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');

    if (!images || images.length === 0) {
        carouselContainer.classList.add('hidden');
        return;
    }

    carouselContainer.classList.remove('hidden');
    totalSlides = images.length;
    currentSlide = 0;
    carouselImages.innerHTML = '';
    indicators.innerHTML = '';

    images.forEach((imageSrc, index) => {
        const img = document.createElement('img');
        img.src = imageSrc;
        img.alt = `Food image ${index + 1}`;
        img.className = `absolute inset-0 w-full h-full object-cover transition-opacity duration-500 ${index === 0 ? 'opacity-100' : 'opacity-0'}`;
        img.style.maxHeight = '400px';
        carouselImages.appendChild(img);

        const indicator = document.createElement('button');
        indicator.className = `w-3 h-3 rounded-full transition-colors duration-200 ${index === 0 ? 'bg-white' : 'bg-white bg-opacity-50'}`;
        indicator.onclick = () => goToSlide(index);
        indicators.appendChild(indicator);
    });

    if (totalSlides > 1) {
        prevBtn.classList.remove('hidden');
        nextBtn.classList.remove('hidden');
    } else {
        prevBtn.classList.add('hidden');
        nextBtn.classList.add('hidden');
    }
}

function changeSlide(direction) {
    if (totalSlides <= 1) return;
    currentSlide += direction;
    if (currentSlide >= totalSlides) currentSlide = 0;
    if (currentSlide < 0) currentSlide = totalSlides - 1;
    updateCarousel();
}

function goToSlide(index) {
    currentSlide = index;
    updateCarousel();
}

function updateCarousel() {
    const images = document.querySelectorAll('#carousel-images img');
    const indicators = document.querySelectorAll('#carousel-indicators button');
    images.forEach((img, index) => {
        img.classList.toggle('opacity-100', index === currentSlide);
        img.classList.toggle('opacity-0', index !== currentSlide);
    });
    indicators.forEach((indicator, index) => {
        indicator.classList.toggle('bg-white', index === currentSlide);
        indicator.classList.toggle('bg-opacity-50', index !== currentSlide);
    });
}

document.getElementById('modal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeModal();
    }
});
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeModal();
    }
});
</script>

<style>
.line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}
.line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
}
</style>
{% else %}
<div class="text-center py-12">
    <div class="mb-4">
        <svg class="mx-auto h-24 w-24 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
        </svg>
    </div>
    <h3 class="text-lg font-medium text-gray-900 mb-2">No food entries yet</h3>
    <p class="text-gray-600 mb-6">Start documenting your culinary journey by adding your first entry!</p>
    <a href="{{ url_for('add_entry') }}" 
       class="inline-flex items-center px-6 py-3 bg-pink-500 text-white font-medium rounded-lg hover:bg-pink-600 transition-colors duration-200">
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
        </svg>
        Add Your First Entry
    </a>
</div>
{% endif %}
{% endblock %}
