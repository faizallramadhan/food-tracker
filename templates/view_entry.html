{% extends "base.html" %}
{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Header with back button -->
    <div class="flex items-center justify-between mb-6">
        <div class="flex items-center gap-4">
            <a href="{{ url_for('index') }}" 
               class="flex items-center gap-2 text-gray-600 hover:text-gray-800 transition-colors duration-200">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
                Back to Food Log
            </a>
        </div>
        <div class="flex items-center gap-3">
            <a href="{{ url_for('edit_entry', entry_id=entry['id']) }}" 
               class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors duration-200 font-medium">
                Edit Entry
            </a>
            <form action="{{ url_for('delete_entry', entry_id=entry['id']) }}" method="post" class="inline"
                  onsubmit="return confirm('Are you sure you want to delete this entry?');">
                <button type="submit" 
                        class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors duration-200 font-medium">
                    Delete Entry
                </button>
            </form>
        </div>
    </div>

    <!-- Main content card -->
    <div class="bg-white shadow-lg rounded-xl overflow-hidden">
        <!-- Entry header -->
        <div class="px-8 py-6 border-b border-gray-200 bg-gradient-to-r from-pink-50 to-purple-50">
            <div class="flex items-start justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-pink-700 mb-2">{{ entry['title'] }}</h1>
                    <div class="flex items-center gap-4 text-sm text-gray-600">
                        <span class="flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                            {{ entry['timestamp'] }}
                        </span>
                        <span class="bg-pink-100 text-pink-800 px-3 py-1 rounded-full font-medium">
                            {{ entry['food_type'] }}
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Image carousel section -->
        {% set all_images = get_all_images(entry['description'], entry['id']) %}
        {% if all_images %}
        <div class="relative" data-total-slides="{{ all_images|length }}">
            <div id="carousel-container" class="relative w-full h-96 bg-gray-100">
                <div id="carousel-images" class="w-full h-full relative">
                    {% for image in all_images %}
                    <img src="{{ image.src }}" 
                         alt="{{ image.alt }}"
                         class="absolute inset-0 w-full h-full object-cover transition-opacity duration-500 {% if loop.first %}opacity-100{% else %}opacity-0{% endif %}"
                         data-slide="{{ loop.index0 }}">
                    {% endfor %}
                </div>
                
                {% if all_images|length > 1 %}
                <!-- Navigation buttons -->
                <button id="prev-btn" 
                        class="absolute top-1/2 left-4 transform -translate-y-1/2 bg-white bg-opacity-90 hover:bg-opacity-100 text-gray-700 rounded-full p-3 shadow-lg transition-all duration-200">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                </button>
                <button id="next-btn" 
                        class="absolute top-1/2 right-4 transform -translate-y-1/2 bg-white bg-opacity-90 hover:bg-opacity-100 text-gray-700 rounded-full p-3 shadow-lg transition-all duration-200">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                </button>

                <!-- Slide indicators -->
                <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 flex gap-2">
                    {% for image in all_images %}
                    <button data-slide="{{ loop.index0 }}" 
                            class="w-3 h-3 rounded-full transition-colors duration-200 slide-indicator {% if loop.first %}bg-white{% else %}bg-white bg-opacity-50{% endif %}">>
                    </button>
                    {% endfor %}
                </div>

                <!-- Image counter -->
                <div class="absolute top-4 right-4 bg-black bg-opacity-50 text-white px-3 py-1 rounded-full text-sm">
                    <span id="current-slide">1</span> / {{ all_images|length }}
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Description content -->
        <div class="px-8 py-6">
            <div class="prose max-w-none text-gray-700 text-lg leading-relaxed">
                <!-- Show description without images (since they're in carousel above) -->
                {{ get_description_without_images(entry['description'])|safe }}
            </div>
        </div>

        <!-- REMOVED: Additional images section to prevent duplication -->
        <!-- The get_all_images() function already includes both embedded and separate images -->
        <!-- So we don't need a separate "Additional Images" section -->
    </div>
</div>

<!-- Full-screen image viewer modal -->
<div id="image-viewer" class="fixed inset-0 bg-black bg-opacity-90 z-50 hidden items-center justify-center p-4">
    <div class="relative max-w-full max-h-full">
        <img id="viewer-image" src="" alt="Full size image" class="max-w-full max-h-full object-contain">
        <button onclick="closeImageViewer()" 
                class="absolute top-4 right-4 text-white hover:text-gray-300 transition-colors duration-200">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </button>
    </div>
</div>

<script>
// Get data from HTML data attributes
const carouselContainer = document.querySelector('[data-total-slides]');
const totalSlides = carouselContainer ? parseInt(carouselContainer.dataset.totalSlides) : 0;
let currentSlide = 0;

function changeSlide(direction) {
    if (totalSlides <= 1) return;
    
    currentSlide += direction;
    if (currentSlide >= totalSlides) currentSlide = 0;
    if (currentSlide < 0) currentSlide = totalSlides - 1;
    
    updateCarousel();
}

function goToSlide(index) {
    currentSlide = index;
    updateCarousel();
}

function updateCarousel() {
    // Update images
    const images = document.querySelectorAll('#carousel-images img');
    images.forEach((img, index) => {
        img.classList.toggle('opacity-100', index === currentSlide);
        img.classList.toggle('opacity-0', index !== currentSlide);
    });
    
    // Update indicators
    const indicators = document.querySelectorAll('.slide-indicator');
    indicators.forEach((indicator, index) => {
        indicator.classList.toggle('bg-white', index === currentSlide);
        indicator.classList.toggle('bg-opacity-50', index !== currentSlide);
    });
    
    // Update counter
    const counter = document.getElementById('current-slide');
    if (counter) {
        counter.textContent = currentSlide + 1;
    }
}

function viewFullImage(src) {
    const viewer = document.getElementById('image-viewer');
    const image = document.getElementById('viewer-image');
    image.src = src;
    viewer.classList.remove('hidden');
    viewer.classList.add('flex');
    document.body.style.overflow = 'hidden';
}

function closeImageViewer() {
    const viewer = document.getElementById('image-viewer');
    viewer.classList.add('hidden');
    viewer.classList.remove('flex');
    document.body.style.overflow = 'auto';
}

// Initialize carousel functionality
document.addEventListener('DOMContentLoaded', function() {
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    
    if (prevBtn) {
        prevBtn.addEventListener('click', () => changeSlide(-1));
    }
    
    if (nextBtn) {
        nextBtn.addEventListener('click', () => changeSlide(1));
    }
    
    // Add click handlers for indicators
    document.querySelectorAll('.slide-indicator').forEach(indicator => {
        indicator.addEventListener('click', function() {
            const slideIndex = parseInt(this.dataset.slide);
            goToSlide(slideIndex);
        });
    });
    
    document.addEventListener('keydown', function(e) {
        if (e.key === 'ArrowLeft') changeSlide(-1);
        if (e.key === 'ArrowRight') changeSlide(1);
        if (e.key === 'Escape') closeImageViewer();
    });
    
    // Close image viewer when clicking outside
    document.getElementById('image-viewer').addEventListener('click', function(e) {
        if (e.target === this) {
            closeImageViewer();
        }
    });
});
</script>

<style>
/* Ensure images in description don't show (they're in carousel) */
.prose img {
    display: none;
}

/* Custom styling for the carousel */
#carousel-container {
    background: linear-gradient(45deg, #f3f4f6, #e5e7eb);
}

/* Smooth transitions for all interactive elements */
.transition-all {
    transition: all 0.3s ease;
}
</style>

{% endblock %}